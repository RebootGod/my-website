cd $FORGE_SITE_PATH

# Git pull
git pull origin $FORGE_SITE_BRANCH

# Fix npm permission issues
if [ -d "node_modules" ]; then
    chmod -R 755 node_modules 2>/dev/null || true
    rm -rf node_modules 2>/dev/null || true
fi

# Clear npm cache
npm cache clean --force 2>/dev/null || true

# Composer install
$FORGE_COMPOSER install --no-interaction --prefer-dist --optimize-autoloader --no-dev

# NPM fresh install and build
npm install --no-audit --no-fund --prefer-offline
npm run build

# Laravel optimizations
$FORGE_PHP artisan config:clear
$FORGE_PHP artisan route:clear
$FORGE_PHP artisan view:clear
$FORGE_PHP artisan cache:clear

# Migrations
$FORGE_PHP artisan migrate --force

# Storage link (ignore if exists)
$FORGE_PHP artisan storage:link 2>/dev/null || echo "Storage link already exists"

# Cache everything
$FORGE_PHP artisan config:cache
$FORGE_PHP artisan route:cache
$FORGE_PHP artisan view:cache
$FORGE_PHP artisan optimize

# Restart queue
$FORGE_PHP artisan queue:restart

# Reload PHP-FPM
( flock -w 10 9 || exit 1
    echo 'Restarting FPM...'; sudo -S service $FORGE_PHP_FPM reload ) 9>/tmp/fpmlock